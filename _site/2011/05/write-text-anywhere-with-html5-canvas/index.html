<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>Write Text Anywhere With HTML5 Canvas | Travis Berry</title>
		<meta name="author" content="Travis Berry">
		<!-- Mobile viewport optimized: j.mp/bplateviewport -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="shortcut icon" type="image/x-icon" href="http://www.travisberry.com/favicon.ico">
		<link rel="alternate" type="application/atom+xml" href="http://www.travisberry.com/atom.xml" />
		<link href="http://www.travisberry.com/css/style.min.cmp.css" media="screen" rel="stylesheet" type="text/css" />
		<link rel="canonical" href="http://www.travisberry.com/2011/05/write-text-anywhere-with-html5-canvas/" />
		<!--[if lt IE 9]>
			<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
		<![endif]-->
		<!--[if lte IE 7]>
			<link href="http://static.travisberry.com/sites/4ddebc054a2ab10001000007/theme/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" />
		<![endif]-->
	</head>
	<body>
		<div id="topBar">
			
				<a href="http://www.travisberry.com/2011/05/create-github-gist-with-ruby"><img src="http://static-assets.travisberry.com/thumbnails/gists_thumb.jpg" alt="Create GitHub Gist With Ruby" title="Create GitHub Gist With Ruby" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/05/write-text-anywhere-with-html5-canvas"><img src="http://static-assets.travisberry.com/thumbnails/canvas_thumb.jpg" alt="Write Text Anywhere With HTML5 Canvas" title="Write Text Anywhere With HTML5 Canvas" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/03/a-day-in-the-life-of-me"><img src="http://static-assets.travisberry.com/thumbnails/selfhomecrop2_thumb.jpg" alt="A Day In The Life Of Me" title="A Day In The Life Of Me" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/02/fast-cakephp-search-with-indextank"><img src="http://static-assets.travisberry.com/thumbnails/indextank_thumb.jpg" alt="Fast CakePHP Search With IndexTank" title="Fast CakePHP Search With IndexTank" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/01/haml-sass-markdown-and-cakephp-oh-my"><img src="http://static-assets.travisberry.com/thumbnails/haml-sass_thumb.jpg" alt="Haml, Sass, Markdown, and CakePHP - Oh My!" title="Haml, Sass, Markdown, and CakePHP - Oh My!" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/01/new-time-tracking-web-app-homkora"><img src="http://static-assets.travisberry.com/thumbnails/homkora-cap_thumb.jpg" alt="New Time Tracking Web App - Homkora" title="New Time Tracking Web App - Homkora" width=20 height=20 /></a>
			
			<noscript style="font-size:12px;vertical-align:middle;">
				For full functionality of this site it is necessary to enable JavaScript.
				Here are the <a href="http://www.enable-javascript.com/" target="_blank">
				instructions how to enable JavaScript in your web browser</a>.
			</noscript>
		</div>
		<div id="wrapper" class="container_12">
			<div id="content">
				<nav>
					<ul id="menu" class="clearfix">
						<li class="link on first last" id="home-link"><a href="/"><span></span>Home</a></li>
						<li class="link on first last" id="blog-link"><a href="/blog/"><span></span>Blog</a></li>
						<li class="link on first last" id="work-link"><a href="/work/"><span></span>Work</a></li>
						<li class="link on first last" id="contact-link"><a href="/contact/"><span></span>Contact</a></li>
					</ul>
					<br class="clear" />
				</nav>
				<div id="post">
<p><article class="post clearfix">
  <h3>Write Text Anywhere With HTML5 Canvas</h3>
  <a href="http://www.flickr.com/photos/paurian/3683348208/" class="postImageLink"><img src="http://oldstatic.travisberry.com/wp-content/uploads/2011/05/canvas.jpg" alt="" class="thumbnail alignleft" width=640 height=280 /></a>
  <h6>Published: May 26, 2012</h6></p>

<p>When working on a project recently I came across the need to be able to add some text to a canvas element. This by itself wasn't particularly hard, as there are several examples of creating text editor apps with canvas, but those all forced the text into a row style grid like a text editor. What I needed was a little more freeform in that I wanted the user to click and the text to show at that point.</p>

<p>After a little hacking around I came up with something that handled my needs and hopefully may help someone else in the future.</p>

<p>(This doesn't look the best in the end, but you can easily add some css styles to make it look better)</p>

<p><a href="http://oldstatic.travisberry.com/demos/canvas-text-demo/index.html">Click Here To See Demo</a></p>

<p>So first we need to create a canvas element</p>

<script src='https://gist.github.com/1177318.js?file=example1.html'></script>


<p><noscript><pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;</p>

<pre><code>&amp;lt;head&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
    &amp;lt;div id=&amp;quot;main&amp;quot;&amp;gt;
        &amp;lt;canvas id=&amp;quot;c&amp;quot;&amp;gt;&amp;lt;/canvas&amp;gt;&amp;lt;!-- the canvas --&amp;gt;
    &amp;lt;/div&amp;gt;
    &amp;lt;script src=&amp;quot;//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
</code></pre>

<p>&lt;/html&gt;</code></pre></noscript></p>

<p>Now we have the canvas element all set up we can start having some fun.</p>

<p>Well not quite. First we need to set some dimensions for the canvas element. Without them, it doesn't have any way to know where to place our "drawings".</p>

<p>Add this into a css file</p>

<script src='https://gist.github.com/1177318.js?file=example2.css'></script>


<p><noscript><pre><code>#c {</p>

<pre><code>width: 640px;
height: 360px;
</code></pre>

<p>}</code></pre></noscript></p>

<p>Now we can start adding drawings. One thing we are going to need for this is a text entry box. I debated trying to "type" directly into the canvas but decided against it. (for complexity reasons)</p>

<p>The method I chose was to add a textarea to the position of the click in the canvas. The user will enter their text into the textarea popup and hit save. This will then draw the text to the screen.</p>

<p>Let's go ahead and create a javascript function to handle the click and add the textarea and save button.</p>

<script src='https://gist.github.com/1177318.js?file=example3.js'></script>


<p><noscript><pre><code>//steal the mousedown event for the canvas for one time - you can use a regular click if you want - this was to interact with some other code in my project
$('#c').mousedown(function(e){</p>

<pre><code>if ($('#textAreaPopUp').length == 0) {
    var mouseX = e.pageX - this.offsetLeft + $(&amp;quot;#c&amp;quot;).position().left;
    var mouseY = e.pageY - this.offsetTop;
    //append a text area box to the canvas where the user clicked to enter in a comment
    var textArea = &amp;quot;&amp;lt;div id='textAreaPopUp' style='position:absolute;top:&amp;quot;+mouseY+&amp;quot;px;left:&amp;quot;+mouseX+&amp;quot;px;z-index:30;'&amp;gt;&amp;lt;textarea id='textareaTest' style='width:100px;height:50px;'&amp;gt;&amp;lt;/textarea&amp;gt;&amp;quot;;
    var saveButton = &amp;quot;&amp;lt;input type='button' value='save' id='saveText' onclick='saveTextFromArea(&amp;quot;+mouseY+&amp;quot;,&amp;quot;+mouseX+&amp;quot;);'&amp;gt;&amp;lt;/div&amp;gt;&amp;quot;;
    var appendString = textArea + saveButton;
    $(&amp;quot;#main&amp;quot;).append(appendString);
} else {
    $('textarea#textareaTest').remove();
    $('#saveText').remove();
    $('#textAreaPopUp').remove();
    var mouseX = e.pageX - this.offsetLeft + $(&amp;quot;#c&amp;quot;).position().left;
    var mouseY = e.pageY - this.offsetTop;
    //append a text area box to the canvas where the user clicked to enter in a comment
    var textArea = &amp;quot;&amp;lt;div id='textAreaPopUp' style='position:absolute;top:&amp;quot;+mouseY+&amp;quot;px;left:&amp;quot;+mouseX+&amp;quot;px;z-index:30;'&amp;gt;&amp;lt;textarea id='textareaTest' style='width:100px;height:50px;'&amp;gt;&amp;lt;/textarea&amp;gt;&amp;quot;;
    var saveButton = &amp;quot;&amp;lt;input type='button' value='save' id='saveText' onclick='saveTextFromArea(&amp;quot;+mouseY+&amp;quot;,&amp;quot;+mouseX+&amp;quot;);'&amp;gt;&amp;lt;/div&amp;gt;&amp;quot;;
    var appendString = textArea + saveButton;
    $(&amp;quot;#main&amp;quot;).append(appendString);
}
</code></pre>

<p>});</code></pre></noscript></p>

<p>Thereâ€™s nothing too crazy in here. It does do a check and destroy the textarea if one is already displayed while the user clicks the canvas again.</p>

<script src='https://gist.github.com/1177318.js?file=example4.js'></script>


<p><noscript><pre><code>var mouseX = e.pageX - this.offsetLeft + $(&quot;#c&quot;).position().left;
var mouseY = e.pageY - this.offsetTop;</code></pre></noscript></p>

<p>These are setting the position of the mouse click so we can use them to set the position to display the textarea at. It takes into account any offsets the canvas element may have as well.</p>

<p>The rest is just appending the textarea to the main element in the page. The save button has an onclick event that we will deal with in a bit.</p>

<p>Now we have to actually draw the entered text to the screen.</p>

<script src='https://gist.github.com/1177318.js?file=example5.js'></script>


<p><noscript><pre><code>function saveTextFromArea(y,x){</p>

<pre><code>//get the value of the textarea then destroy it and the save button
var text = $('textarea#textareaTest').val();
$('textarea#textareaTest').remove();
$('#saveText').remove();
//get the canvas and add the text functions
var canvas = document.getElementById('c');
var ctx = canvas.getContext('2d');
var cw = canvas.clientWidth;
var ch = canvas.clientHeight;
canvas.width = cw;
canvas.height = ch;
//break the text into arrays based on a text width of 100px
var phraseArray = getLines(ctx,text,100);
// this adds the text functions to the ctx
CanvasTextFunctions.enable(ctx);
var counter = 0;
//set the font styles
var font = &amp;quot;sans&amp;quot;;
var fontsize = 16;
ctx.strokeStyle = &amp;quot;rgba(237,229,0,1)&amp;quot;;
ctx.shadowOffsetX = 2;
ctx.shadowOffsetY = 2;
ctx.shadowBlur = 1;
ctx.shadowColor = &amp;quot;rgba(0,0,0,1)&amp;quot;;
//draw each phrase to the screen, making the top position 20px more each time so it appears there are line breaks
$.each(phraseArray, function() {
    //set the placement in the canvas
    var lineheight = fontsize * 1.5;
    var newline = ++counter;
    newline = newline * lineheight;
    var topPlacement = y - $(&amp;quot;#c&amp;quot;).position().top + newline;
    var leftPlacement = x - $(&amp;quot;#c&amp;quot;).position().left;
    text = this;
    //draw the text
    ctx.drawText(font, fontsize, leftPlacement, topPlacement, text);
    ctx.save();
    ctx.restore();
});
//reset the drop shadow so any other drawing don't have them
ctx.shadowOffsetX = 0;
ctx.shadowOffsetY = 0;
ctx.shadowBlur = 0;
ctx.shadowColor = &amp;quot;rgba(0,0,0,0)&amp;quot;;
</code></pre>

<p>}</code></pre></noscript></p>

<p>So this is fairly intense. It also uses a little library file from Jim Studt that you can find <a href="http://www.federated.com/~jim/canvastext/">here</a>. Though I have modified mine a bit because of some conflicts it was causing me. You can grab my copy at <a href="https://github.com/ninetwentyfour/Video-Canvas/blob/master/js/text.js">https://github.com/ninetwentyfour/Video-Canvas/blob/master/js/text.js</a></p>

<p>A few important parts in that code are</p>

<script src='https://gist.github.com/1177318.js?file=example6.js'></script>


<p><noscript><pre><code>//break the text into arrays based on a text width of 100px
var phraseArray = getLines(ctx,text,100);</code></pre></noscript></p>

<p>This is going to another function that we will write in a minute. Basically it is solving the problem of canvas text not having any idea how to word wrap. It will blow right off the page without this.</p>

<script src='https://gist.github.com/1177318.js?file=example7.js'></script>


<p><noscript><pre><code>// this adds the text functions to the ctx
CanvasTextFunctions.enable(ctx);</code></pre></noscript></p>

<p>This intializes the text library file.</p>

<script src='https://gist.github.com/1177318.js?file=example8.js'></script>


<p><noscript><pre><code>//draw each phrase to the screen, making the top position 20px more each time so it appears there are line breaks
$.each(phraseArray, function() {</p>

<pre><code>//set the placement in the canvas
var lineheight = fontsize * 1.5;
var newline = ++counter;
newline = newline * lineheight;
var topPlacement = y - $(&amp;quot;#c&amp;quot;).position().top + newline;
var leftPlacement = x - $(&amp;quot;#c&amp;quot;).position().left;
text = this;
//draw the text
ctx.drawText(font, fontsize, leftPlacement, topPlacement, text);
ctx.save();
ctx.restore();
</code></pre>

<p>});</code></pre></noscript></p>

<p>This is the block that actually draws the text to the screen. It takes each entry in the phraseArray and draws it to the screen moving it down by a line each time.</p>

<p>The code to control the width of the text looks like this</p>

<script src='https://gist.github.com/1177318.js?file=example9.js'></script>


<p><noscript><pre><code>function getLines(ctx,phrase,maxPxLength) {</p>

<pre><code>//break the text area text into lines based on &amp;quot;box&amp;quot; width
var wa=phrase.split(&amp;quot; &amp;quot;),
phraseArray=[],
lastPhrase=&amp;quot;&amp;quot;,
l=maxPxLength,
measure=0;
ctx.font = &amp;quot;16px sans-serif&amp;quot;;
for (var i=0;i&amp;lt;wa.length;i++) {
    var w=wa[i];
    measure=ctx.measureText(lastPhrase+w).width;
    if (measure&amp;lt;l) {
        lastPhrase+=(&amp;quot; &amp;quot;+w);
    }else {
        phraseArray.push(lastPhrase);
        lastPhrase=w;
    }
    if (i===wa.length-1) {
        phraseArray.push(lastPhrase);
        break;
}
}
return phraseArray;
</code></pre>

<p>}</code></pre></noscript></p>

<p>This takes the canvas variable the original text and the width you want to limit it to then returns an array of pharses limited to the length you pass.</p>

<p>Once you have all this done you should have a working example. My final code looks like this.</p>

<script src='https://gist.github.com/1177318.js?file=example10.html'></script>


<p><noscript><pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;</p>

<pre><code>&amp;lt;head&amp;gt;
    &amp;lt;style&amp;gt;
        body {
            background: #111;
            color:#eee;
        }
        #c {
            width: 640px;
            height: 360px;
            border:1px solid #111;
            float:left;
            background:#eee;
        }
        #main{
            width:650px;
            margin:auto;
        }
    &amp;lt;/style&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
    &amp;lt;div id=&amp;quot;main&amp;quot;&amp;gt;
        &amp;lt;canvas id=&amp;quot;c&amp;quot;&amp;gt;&amp;lt;/canvas&amp;gt;&amp;lt;!-- the canvas --&amp;gt;
    &amp;lt;/div&amp;gt;
    &amp;lt;script src=&amp;quot;http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;script type=&amp;quot;text/javascript&amp;quot; src=&amp;quot;text.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;!-- Library to help text --&amp;gt;
    &amp;lt;script type=&amp;quot;text/javascript&amp;quot;&amp;gt;
        $('#c').mousedown(function(e){
            if ($('#textAreaPopUp').length == 0) {
                var mouseX = e.pageX - this.offsetLeft + $(&amp;quot;#c&amp;quot;).position().left;
                var mouseY = e.pageY - this.offsetTop;

                //append a text area box to the canvas where the user clicked to enter in a comment
                var textArea = &amp;quot;&amp;lt;div id='textAreaPopUp' style='position:absolute;top:&amp;quot;+mouseY+&amp;quot;px;left:&amp;quot;+mouseX+&amp;quot;px;z-index:30;'&amp;gt;&amp;lt;textarea id='textareaTest' style='width:100px;height:50px;'&amp;gt;&amp;lt;/textarea&amp;gt;&amp;quot;;
                var saveButton = &amp;quot;&amp;lt;input type='button' value='save' id='saveText' onclick='saveTextFromArea(&amp;quot;+mouseY+&amp;quot;,&amp;quot;+mouseX+&amp;quot;);'&amp;gt;&amp;lt;/div&amp;gt;&amp;quot;;
                var appendString = textArea + saveButton;
                $(&amp;quot;#main&amp;quot;).append(appendString);
            } else {
                $('textarea#textareaTest').remove();
                $('#saveText').remove();
                $('#textAreaPopUp').remove();
                var mouseX = e.pageX - this.offsetLeft + $(&amp;quot;#c&amp;quot;).position().left;
                var mouseY = e.pageY - this.offsetTop;
                //append a text area box to the canvas where the user clicked to enter in a comment
                var textArea = &amp;quot;&amp;lt;div id='textAreaPopUp' style='position:absolute;top:&amp;quot;+mouseY+&amp;quot;px;left:&amp;quot;+mouseX+&amp;quot;px;z-index:30;'&amp;gt;&amp;lt;textarea id='textareaTest' style='width:100px;height:50px;'&amp;gt;&amp;lt;/textarea&amp;gt;&amp;quot;;
                var saveButton = &amp;quot;&amp;lt;input type='button' value='save' id='saveText' onclick='saveTextFromArea(&amp;quot;+mouseY+&amp;quot;,&amp;quot;+mouseX+&amp;quot;);'&amp;gt;&amp;lt;/div&amp;gt;&amp;quot;;
                var appendString = textArea + saveButton;
                $(&amp;quot;#main&amp;quot;).append(appendString);
            }
        });

        function saveTextFromArea(y,x){
            //get the value of the textarea then destroy it and the save button
            var text = $('textarea#textareaTest').val();
            $('textarea#textareaTest').remove();
            $('#saveText').remove();
            $('#textAreaPopUp').remove();
            //get the canvas and add the text functions
            var canvas = document.getElementById('c');
            var ctx = canvas.getContext('2d');
            var cw = canvas.clientWidth;
            var ch = canvas.clientHeight;
            canvas.width = cw;
            canvas.height = ch;
            //break the text into arrays based on a text width of 100px
            var phraseArray = getLines(ctx,text,100);
            // this adds the text functions to the ctx
            CanvasTextFunctions.enable(ctx);
            var counter = 0;
            //set the font styles
            var font = &amp;quot;sans&amp;quot;;
            var fontsize = 16;
            ctx.strokeStyle = &amp;quot;rgba(237,229,0,1)&amp;quot;;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.shadowBlur = 1;
            ctx.shadowColor = &amp;quot;rgba(0,0,0,1)&amp;quot;;
            //draw each phrase to the screen, making the top position 20px more each time so it appears there are line breaks
            $.each(phraseArray, function() {
                //set the placement in the canvas
                var lineheight = fontsize * 1.5;
                var newline = ++counter;
                newline = newline * lineheight;
                var topPlacement = y - $(&amp;quot;#c&amp;quot;).position().top + newline;
                var leftPlacement = x - $(&amp;quot;#c&amp;quot;).position().left;
                text = this;
                //draw the text
                ctx.drawText(font, fontsize, leftPlacement, topPlacement, text);
                ctx.save();
                ctx.restore();
            });
            //reset the drop shadow so any other drawing don't have them
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.shadowBlur = 0;
            ctx.shadowColor = &amp;quot;rgba(0,0,0,0)&amp;quot;;
        }

        function getLines(ctx,phrase,maxPxLength) {
            //break the text area text into lines based on &amp;quot;box&amp;quot; width
            var wa=phrase.split(&amp;quot; &amp;quot;),
            phraseArray=[],
            lastPhrase=&amp;quot;&amp;quot;,
            l=maxPxLength,
            measure=0;
            ctx.font = &amp;quot;16px sans-serif&amp;quot;;
            for (var i=0;i&amp;lt;wa.length;i++) {
                var w=wa[i];
                measure=ctx.measureText(lastPhrase+w).width;
                if (measure&amp;lt;l) {
                    lastPhrase+=(&amp;quot; &amp;quot;+w);
                }else {
                    phraseArray.push(lastPhrase);
                    lastPhrase=w;
                }
                if (i===wa.length-1) {
                    phraseArray.push(lastPhrase);
                    break;
                }
            }
            return phraseArray;
        }
    &amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
</code></pre>

<p>&lt;/html&gt;</code></pre></noscript></p>

<p>This is a pretty basic and is missing a few things that would make it more helpful but it should give you a good start. Please feel free to leave questions or advice on better ways to do this in the comments.</p>

<p></article></p>

</div>
<p>Comments have been removed in my sites latest upgrade. They may or may not come back.</p>
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>30 May 2011</span> &raquo; <a href="/2011/05/create-github-gist-with-ruby">Create GitHub Gist With Ruby</a></li>
    
      <li><span>04 Mar 2011</span> &raquo; <a href="/2011/03/a-day-in-the-life-of-me">A Day In The Life Of Me</a></li>
    
      <li><span>16 Feb 2011</span> &raquo; <a href="/2011/02/fast-cakephp-search-with-indextank">Fast CakePHP Search With IndexTank</a></li>
    
  </ul>
</div>
			</div> <!-- end content -->
			<div class="clear"></div>
			<footer id="footer" class="grid_12">
				<h1><a href="/">Travis Berry</a></h1>
			</footer> <!-- end footer -->
			<div class="clear"></div>
		</div> <!-- end wrapper -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
		<script src="http://oldstatic.travisberry.com/search.min.js"></script>
		<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-11593601-1']);
		  _gaq.push(['_trackPageview']);
		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		</script>
		<!--[if lte IE 7]>
		<script type="text/javascript"> 
			/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
			var IE6UPDATE_OPTIONS = {
				icons_path: "http://static-assets.travisberry.com/ie6update/images/"
			}
		</script>
		<script type="text/javascript" src="http://static-assets.travisberry.com/ie6update/ie6update.js"></script>
		<![endif]-->
	</body>
</html>