<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>Fast CakePHP Search With IndexTank | Travis Berry</title>
		<meta name="author" content="Travis Berry">
		<!-- Mobile viewport optimized: j.mp/bplateviewport -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="shortcut icon" type="image/x-icon" href="http://www.travisberry.com/favicon.ico">
		<link rel="alternate" type="application/atom+xml" href="http://www.travisberry.com/atom.xml" />
		<link href="http://www.travisberry.com/css/style.min.cmp.css" media="screen" rel="stylesheet" type="text/css" />
		<link rel="canonical" href="http://www.travisberry.com/2011/02/fast-cakephp-search-with-indextank/" />
		<!--[if lt IE 9]>
			<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
		<![endif]-->
		<!--[if lte IE 7]>
			<link href="http://static.travisberry.com/sites/4ddebc054a2ab10001000007/theme/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" />
			<script type="text/javascript" src="http://static-assets.travisberry.com/js/unitpngfix.js"></script>
		<![endif]-->
	</head>
	<body>
		<div id="topBar">
			
				<a href="http://www.travisberry.com/2012/02/hubot-deploy"><img src="http://static-assets.travisberry.com/thumbnails/hubot-capistrano_thumb.jpg" alt="Hubot Deploy" title="Hubot Deploy" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/12/so-long-and-thanks-for-the-elephant"><img src="http://static-assets.travisberry.com/thumbnails/elephant_thumb.jpg" alt="So Long And Thanks For The Elephant" title="So Long And Thanks For The Elephant" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/09/hospitium-new-open-source-project"><img src="http://static-assets.travisberry.com/thumbnails/hospitium_thumb.jpg" alt="Hospitium - New Open Source Project" title="Hospitium - New Open Source Project" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/09/goodbye-wordpress-hello-jekyll"><img src="http://static-assets.travisberry.com/thumbnails/jekyll_thumb.jpg" alt="Goodbye WordPress - Hello Jekyll" title="Goodbye WordPress - Hello Jekyll" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/05/create-github-gist-with-ruby"><img src="http://static-assets.travisberry.com/thumbnails/gists_thumb.jpg" alt="Create GitHub Gist With Ruby" title="Create GitHub Gist With Ruby" width=20 height=20 /></a>
			
				<a href="http://www.travisberry.com/2011/05/write-text-anywhere-with-html5-canvas"><img src="http://static-assets.travisberry.com/thumbnails/canvas_thumb.jpg" alt="Write Text Anywhere With HTML5 Canvas" title="Write Text Anywhere With HTML5 Canvas" width=20 height=20 /></a>
			
			<noscript style="font-size:12px;vertical-align:middle;">
				For full functionality of this site it is necessary to enable JavaScript.
				Here are the <a href="http://www.enable-javascript.com/" target="_blank">
				instructions how to enable JavaScript in your web browser</a>.
				<style>
					pre{
					  text-shadow: none !important;
					  font-size:14px;
					  background-color: #111111;
					  color: #CAF715;
						padding:10px;
						margin-bottom:20px;
						overflow:auto;
					}
				</style>
			</noscript>
		</div>
		<div id="wrapper" class="container_12">
			<div id="content">
				<nav>
					<ul id="menu" class="clearfix">
						<li class="link on first last" id="home-link"><a href="/"><span></span>Home</a></li>
						<li class="link on first last" id="blog-link"><a href="/blog/"><span></span>Blog</a></li>
						<li class="link on first last" id="work-link"><a href="/work/"><span></span>Work</a></li>
						<li class="link on first last" id="contact-link"><a href="/contact/"><span></span>Contact</a></li>
					</ul>
					<br class="clear" />
				</nav>
				<div id="post">
<p><article class="post clearfix">
  <h3>Fast CakePHP Search With IndexTank</h3>
  <a href="http://commons.wikimedia.org/wiki/File:Marines-tank-Korea-19530705.JPEG" class="postImageLink"><img src="http://oldstatic.travisberry.com/wp-content/uploads/2011/02/indextank.jpg" alt="" class="thumbnail alignleft" width=640 height=280 /></a>
  <h6>Published: February 16, 2011</h6></p>

<p>I've previously posted my <a href="http://oldstatic.travisberry.com/2010/06/create-a-ghetto-but-functional-search-function-for-cakephp/">ghetto CakePHP search function</a>. This time I'm going to show you a much better method, mainly by offloading the work to people who really know how to do search. That's where <a href="http://indextank.com/">IndexTank</a> comes in - they know how to do search. They power the search for Reddit, WordPress.com, and many others.</p>

<p>You simply hand them the documents you want indexed and the give you back the ability to query against it.</p>

<p>I'm not going to spend anytime explaining how IndexTank works, mainly because I barely understand it. Instead I will show you a simple way to get it to work with CakePHP.</p>

<p>The code in this example is built around the code for <a href="http://homkora.com">Homkora</a> in which the main two Objects are Projects and Timers. So to start grab the IndexTank library from <a href="https://indextank.com/documentation/php-client">https://indextank.com/documentation/php-client</a> this would be a good page to read as well just to get an idea of what's going on.</p>

<p>Take the file you downloaded (indextank_client.php in my case) and place it in app/vendors of your CakePHP application.</p>

<p>Now open up your app_controller.php and add these four functions</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example1.php'></script><noscript><pre><code>&lt;?php
function createIndextankClient(){
    App::import('Vendor', 'indextank_client');
    $API_URL = 'YOUR API URL HERE';
    $client = new ApiClient($API_URL);
    return $client;
}
   
function addIndextank($indexType,$id,$data){
    //send project to indextank
    $client = $this-&gt;createIndextankClient();
    $index = $client-&gt;get_index($indexType);
    $doc_id = $id;
    $index-&gt;add_document($doc_id, $data);
}
   
function deleteIndextank($indexType,$id){
    //delete indextank document
    $client = $this-&gt;createIndextankClient();
    $index = $client-&gt;get_index($indexType);
    $index-&gt;delete_document($id);
}
   
function searchIndextank($indexType,$query){
    //search indextank
    $client = $this-&gt;createIndextankClient();
    $index = $client-&gt;get_index($indexType);
    $index-&gt;add_function(2, &quot;relevance&quot;);
    $res = $index-&gt;search($query);
    return $res;
}
?&gt;</code></pre></noscript>
</div>


<p>These are the three functions that call to IndexTank directly and the one that creates the IndexTank client object. It imports the library and create a new $client object.</p>

<p>Each one is built to be passed the variables it needs to make a connection to IndexTank.</p>

<p>All the functions accept the $indexType variable which is where you set which index to perform actions against. In my case I have one for Projects and one for Timers.</p>

<p>So now lets add some documents to our index.</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example2.php'></script><noscript><pre><code>&lt;?php
if ($this-&gt;Project-&gt;save($this-&gt;data)) {
    $this-&gt;Session-&gt;setFlash('The project has been saved', 'default', array('class' =&gt; 'flash_good'));
    $this-&gt;redirect(array('action' =&gt; 'index'));
}
?&gt;</code></pre></noscript>
</div>


<p>I'm going to assume you having something similar in your controller. In this case it's in my add() function in the projects controller.</p>

<p>Let's add the code to call our addIndextank() function in the app controller.</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example3.php'></script><noscript><pre><code>&lt;?php
if ($this-&gt;Project-&gt;save($this-&gt;data)) {
    //send project to index tank
    $indexData = array('text'=&gt;$this-&gt;data['Project']['title'],'title'=&gt;$this-&gt;data['Project']['title'],'description'=&gt;$this-&gt;data['Project']['description'],'user_id'=&gt;$_SESSION['Auth']['User']['_id']);
    $id = $this-&gt;Project-&gt;id;
    $this-&gt;addIndextank(&quot;HomkoraProjects&quot;,$id,$indexData);
    $this-&gt;Session-&gt;setFlash('The project has been saved', 'default', array('class' =&gt; 'flash_good'));
    $this-&gt;redirect(array('action' =&gt; 'index'));
}
?&gt;</code></pre></noscript>
</div>


<p>Let go over what's going on here.</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example4.php'></script><noscript><pre><code>&lt;?php
$indexData = array('text'=&gt;$this-&gt;data['Project']['title'],'title'=&gt;$this-&gt;data['Project']['title'],'description'=&gt;$this-&gt;data['Project']['description'],'user_id'=&gt;$_SESSION['Auth']['User']['_id']);
?&gt;</code></pre></noscript>
</div>


<p>This line is setting the data that will be indexed. The 'text' field is one used by IndexTank by default and I recommend setting it to the type of query that will be preformed the most.</p>

<p>The key value pairs after 'text' can be whatever other data you would like to save and be able to query against.</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example5.php'></script><noscript><pre><code>&lt;?php $id = $this-&gt;Project-&gt;id; ?&gt;</code></pre></noscript>
</div>


<p>Simply sets the ID that is going to be used for the document ID in IndexTank. I figured it best to keep them the same as in the application database so this sets it as the last saved Project ID.</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example6.php'></script><noscript><pre><code>&lt;?php $this-&gt;addIndextank(&quot;HomkoraProjects&quot;,$id,$indexData); ?&gt;</code></pre></noscript>
</div>


<p>This line is the call to the addIndextank function. The "HomkoraProjects" is what is passed as $indexType in the app_controller and is basically the name of the index. We then pass the ID and the data to be indexed too.</p>

<p>Now when you add a new Project you should also be adding a new document to IndexTank.</p>

<p>Now if you delete the Project it's best to delete to document in the index as well. So let's add some code to our projects controller delete() function.</p>

<p>Starting with</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example7.php'></script><noscript><pre><code>&lt;?php
if ($this-&gt;Project-&gt;delete($id)) {
    $this-&gt;Session-&gt;setFlash('Project deleted', 'default', array('class' =&gt; 'flash_good'));
    $this-&gt;redirect(array('action'=&gt;'index'));
}
?&gt;</code></pre></noscript>
</div>


<p>We can add a simple call like</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example8.php'></script><noscript><pre><code>&lt;?php 
if ($this-&gt;Project-&gt;delete($id)) {
    $this-&gt;deleteIndextank(&quot;HomkoraProjects&quot;,$id);
    $this-&gt;Session-&gt;setFlash('Project deleted', 'default', array('class' =&gt; 'flash_good'));
    $this-&gt;redirect(array('action'=&gt;'index'));
}
?&gt;</code></pre></noscript>
</div>


<p>Deleting documents requires a lot less information so we just have to pass it the $indexType and the ID (which should match between your app and IndexTank if you add documents using the above example)</p>

<p>Alright, now you can add and remove documents from your index, but what good are they without being able to search against them.</p>

<p>In my projects controller I added the following function</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177288.js?file=example9.php'></script><noscript><pre><code>&lt;?php
function search(){
    $query = $this-&gt;data['Project']['search'];
    $res = $this-&gt;searchIndextank(&quot;HomkoraProjects&quot;,$query);
    $i = 0;
    foreach($res-&gt;results as $doc_id){
    $params = array(
        'conditions' =&gt; array('_id' =&gt; $doc_id-&gt;docid)
    );
        $projects[$i++] = $this-&gt;Project-&gt;find('first',$params);
    }
    $this-&gt;set('projects', $projects);
}
?&gt;</code></pre></noscript>
</div>




<div class="gistFallback">
<script src='https://gist.github.com/1177293.js?file=example10.php'></script><noscript><pre><code>&lt;?php $query = $this-&gt;data['Project']['search']; ?&gt;</code></pre></noscript>
</div>


<p>I pass the search term through a form and set it as the $query variable.</p>

<div class="gistFallback">
<script src='https://gist.github.com/1177293.js?file=example11.php'></script><noscript><pre><code>&lt;?php $res = $this-&gt;searchIndextank(&quot;HomkoraProjects&quot;,$query); ?&gt;</code></pre></noscript>
</div>


<p>Here I call our searchIndextank() function and pass it the $indexType again and the query to perform.</p>

<p>You'll notice in the searchIndextank() I return the data $res and in the search() function I set it to $res.</p>

<p>Once I get the results from IndexTank I can use them to search for the Projects in my database. Here I set them all the the $projects array and prepare them for display in the view.</p>

<p>I know you're thinking, if you are getting the data from the database anyway - why use IndexTank?</p>

<p>Well with only a few records, you aren't going to get a much faster result, but with lots of records, IndexTank will return the results faster plus it allows you to cut down on your database calls. Their ability to rank results and search based on numerous factors is pretty good and better than what the average person can write in most cases.</p>

<p>I'm using a pretty bare bones searchIndextank() function but this should get you started. I'm quite impressed with the results so far and I'm continuing to find better ways to work with their index.</p>

<p>If you know a better way to set this up, or have questions, let me know in the comments.
</article></p>

</div>
<p>Comments are so 2010. Continue the discussion on twitter. <a href="https://twitter.com/#!/travisberry">@travisberry</a></p>
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>16 Feb 2012</span> &raquo; <a href="/2012/02/hubot-deploy">Hubot Deploy</a></li>
    
      <li><span>24 Dec 2011</span> &raquo; <a href="/2011/12/so-long-and-thanks-for-the-elephant">So Long And Thanks For The Elephant</a></li>
    
      <li><span>05 Sep 2011</span> &raquo; <a href="/2011/09/hospitium-new-open-source-project">Hospitium - New Open Source Project</a></li>
    
  </ul>
</div>
			</div> <!-- end content -->
			<div class="clear"></div>
			<footer id="footer" class="grid_12">
				<h1><a href="/">Travis Berry</a></h1>
			</footer> <!-- end footer -->
			<div class="clear"></div>
		</div> <!-- end wrapper -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
		<script src="http://oldstatic.travisberry.com/search.min.js"></script>
		<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-11593601-1']);
		  _gaq.push(['_trackPageview']);
		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		</script>
		<!--[if lte IE 7]>
		<script type="text/javascript"> 
			/*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; } 
			var IE6UPDATE_OPTIONS = {
				icons_path: "http://static-assets.travisberry.com/ie6update/images/"
			}
		</script>
		<script type="text/javascript" src="http://static-assets.travisberry.com/ie6update/ie6update.js"></script>
		<![endif]-->
	</body>
</html>